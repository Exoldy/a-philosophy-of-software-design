# **ГЛАВА 16. МОДИФИКАЦИЯ СУЩЕСТВУЮЩЕГО КОДА**

### **(Или «Операция на открытом сердце говномонта»)**

Как тебе уже пояснили в первой главе, разработка софта — это, сука, итеративный процесс. Крупная система растет через стадии эволюции, как покемон, только вместо новых абилок она обрастает легаси и костылями. Дизайн системы вечно мутирует.

Сразу придумать идеальную архитектуру **невозможно**, даже не пытайся. Дизайн зрелой системы определяется не тем, что ты там нафантазировал на старте, а тем, как её насиловали правками в процессе жизни. В прошлых главах мы говорили, как не наговнокодить с нуля; в этой поговорим, как не дать энтропии и пиздецу поглотить проект, когда он уже запущен.

## **16.1 Оставайся стратегом, блять**

В 3-й главе мы уже перетирали за разницу между тактическим («хуяк-хуяк и в продакшн») и стратегическим программированием.
*   **Тактика:** Главное, чтобы работало *сейчас*. Даже если код выглядит как блевотина.
*   **Стратегия:** Главное — крутой дизайн системы.

Тактический подход мгновенно превращает проект в помойку. Если ты хочешь систему, которую можно поддерживать, критерий «оно работает» — это для лохов. Ты должен думать о дизайне, даже когда просто ковыряешь старый код.

Но реальность сурова. Когда разрабы лезут чинить баги или пилить фичи в старом коде, у них отключается мозг и включается режим ссыкла. Типичная мысль: *«Какое минимальное изменение я могу сделать, чтобы ничего не сломать и свалить домой?»*.
Они боятся кода. Они думают, что серьезный рефакторинг принесет новые баги. Но этот страх порождает **тактическое говнокодерство**. Каждая такая «минимальная правка» добавляет новый if-чик, лишнюю зависимость или спец-кейс. В итоге система гниет с каждым коммитом.

Хочешь чистый код? Будь мужиком, включай стратегическое мышление.
После твоей правки код должен выглядеть так, как будто эта фича была там задумана изначально архитекторами из NASA.
Видишь искушение сделать быстрый фикс? Бей себя по рукам. Подумай: подходит ли текущий дизайн под новую задачу? Если нет — **рефактори, сука**. Только так дизайн становится лучше, а не скатывается в сраное болото.

Это та самая «инвестиция», о которой говорили на 15-й странице. Потратишь лишний час на рефакторинг сейчас — сэкономишь дни потом. Если ты трогаешь код и не делаешь дизайн лучше, ты, скорее всего, делаешь его хуже.

Конечно, иногда бизнес держит паяльник у твоей жопы. Если правильный рефакторинг займет три месяца, а быстрый грязный хак — два часа, и дедлайн был вчера — придется говнокодить. Но сопротивляйся этому до последнего! Спроси себя: «Это реально лучшее, что я могу сделать в этих скотских условиях?». Может, можно сделать не идеально, но хотя бы не совсем убого за пару дней?
Каждая контора должна выделять время на разгребание технического долга, иначе этот долг вас похоронит.

## **16.2 Актуализация комментов: держи их рядом с кодом**

Когда ты меняешь код, старые комменты превращаются в наглый пиздёж. Забыть обновить коммент — святое дело. В итоге читатель видит одно, а код делает другое. Это бесит, и люди перестают верить комментам вообще. Но есть способ не быть мудаком.

**Держи комменты рядом с кодом.** Чем дальше описание от мяса, тем меньше шансов, что ты его вспомнишь поправить.
Например, описание интерфейса метода должно быть прямо над методом в файле с кодом. Ты всё равно туда полезешь править логику, увидишь коммент и (возможно) обновишь его.

Любители C/C++ сейчас начнут ныть про хедеры (.h файлы). Мол, интерфейс там. Но это далеко от тела функции. Разрабу лень открывать другой файл, чтобы поправить текст. Некоторые говорят: «Хедеры нужны, чтобы юзер видел API и не смотрел в кишки кода». Да срать я хотел на это. Юзеры должны читать доку, сгенерированную Doxygen или Javadoc, а не лазить по сырцам. А IDE сейчас умные, сами подтянут доку куда надо. Так что пиши там, где удобно **тебе** — рядом с кодом.

Внутри метода не надо сваливать все комменты в кучу сверху. Размажь их по коду.
*Пример:*
Вместо стены текста в начале, сделай так:

```java
// План капкан (3 фазы):
// 1. Ищем кандидатов
// 2. Ставим им оценки
// 3. Выбираем лучшего и выкидываем на мороз
```
А детали пиши уже перед конкретными блоками кода.
**Правило:** Чем дальше коммент от кода, тем более абстрактным он должен быть, чтобы не протухнуть при первой же мелкой правке.

## **16.3 Комменты — в код, а не в git log**

Классическая ошибка долбоёба: расписать причину сложного изменения в Commit Message, а в коде оставить пустоту.
Ты реально думаешь, что через год кто-то будет копаться в `git log`, чтобы понять, почему тут стоит этот костыль? Хер там. Даже если полезут, хрен найдут.

Пишешь коммит? Спроси себя: «Эта инфа пригодится потомкам?». Если да — **пиши её в код**.
Пример: ты пофиксил хитрый баг. Если не написать об этом в коде, придет новый «умный» разраб, увидит «странный код», удалит твой фикс и вернет баг обратно.
Git log — это кладбище истории, туда никто не ходит без крайней нужды. Код — вот где живут знания.

## **16.4 Не плоди сущности (DRY для доки)**

Второй способ держать комменты свежими — **не копипастить**.
Если одно и то же написано в трех местах, ты поменяешь в одном и забудешь в двух других. Поздравляю, у тебя рассинхрон.
Найди **одно** место для доки. В остальных поставь ссылку: *«Смотри описание переменной X, там всё разжевано»*. Если ссылка протухнет — это сразу видно (коммента нет), а если протухнет текст копипасты — ты будешь дебажить этот обман часами.

Если идеального места нет — создай файл `designNotes`.

И не надо пересказывать в комментах то, что делает другой модуль. Или переписывать спецификацию HTTP.
*Пример:*
```java
// Реализует команду Foo. Читай мануал, там всё есть. Ссылка вот.
```
Не пытайся переписать весь интернет в своих комментах. Просто дай ссылку.

## **16.5 Чекни диффы, не будь ленивым**

Перед тем как набрать `git commit`, потрать две минуты и посмотри `git diff`. Пробегись глазами по тому, что ты наворотил.
Это лучший способ заметить, что ты:
1. Забыл обновить коммент.
2. Оставил `console.log("TEST KEK")`.
3. Забыл TODO.

## **16.6 Высокоуровневые комменты живут дольше**

И напоследок: комменты, которые описывают **ЧТО** и **ЗАЧЕМ** (а не *КАК*), живут дольше. Детали реализации меняются часто, а общая суть — редко. Чем абстрактнее коммент, тем реже его надо переписывать. Пиши умно, а не дословно переводи код на человеческий.