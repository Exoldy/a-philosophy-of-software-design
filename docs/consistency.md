# **17. Консистентность (Единообразие)**

Единообразие (оно же консистентность) — это мощнейший инструмент, чтобы снизить градус безумия в системе и сделать её поведение хоть немного предсказуемым. Если система согласована, это значит, что похожие вещи делаются похожими способами, а разные — разными. Логично, да?

Это создает **когнитивный рычаг**: один раз вкурив, как работает какая-то херня в одном месте, ты автоматически понимаешь, как она работает везде. Если же система написана в стиле «кто в лес, кто по дрова», разработчикам приходится изучать каждый кусок кода с нуля. А это, сука, время.

Единообразие снижает количество косяков. Если система неконсистентна, две ситуации могут выглядеть одинаково, но вести себя по-разному. Ты видишь знакомый паттерн, расслабляешь булки, делаешь предположение — и всё падает, потому что здесь это работает *иначе*. В нормальной системе твои привычки работают на тебя. Единообразие позволяет кодить быстрее и не обсираться на ровном месте.

## **17.1 Примеры консистентности**

Единообразие можно наводить на разных уровнях, вот тебе примеры:

**Имена.** В 14-й главе мы уже перетерли за то, почему называть переменные от балды — плохая идея. Не будем повторяться.

**Стиль кода.** Сейчас в любой приличной конторе есть стайл-гайды. Они ограничивают твою «творческую натуру» даже жестче, чем компилятор. Отступы, где ставить ебучие фигурные скобки, порядок объявлений, нейминг — всё расписано. Это нужно не для того, чтобы тебя унизить, а чтобы код было легко читать и чтобы ты не выстрелил себе в ногу «опасными фичами» языка.

**Интерфейсы.** Интерфейс с кучей реализаций — это классика единообразия. Понял одну реализацию — поймешь и остальные, потому что ты уже знаешь, чего от них ждать.

**Паттерны проектирования.** Это общепринятые костыли для типовых проблем (типа MVC для интерфейсов). Если ты берешь готовый паттерн, реализация пойдет быстрее, оно с большей вероятностью заработает, и любой, кто будет читать твой код, сразу поймет: «Ага, это MVC», а не будет гадать, что ты там нагородил. Подробнее об этом в главе 19.5, не переключайтесь.

**Инварианты.** Это такая штука, которая всегда истинна. Например, структура данных для текста может гарантировать инвариант: «каждая строка заканчивается символом переноса». Инварианты избавляют тебя от написания кучи `if`-ов для обработки крайних случаев и упрощают понимание того, как этот код вообще живет.

## **17.2 Как обеспечить единообразие (Бить линейкой по рукам)**

Держать марку сложно, особенно когда над проектом годами трудится толпа народу. Одна команда не знает, что придумала другая. Приходят новички (васяны), которые не знают правил, нарушают их и создают свои, конфликтующие с тем, что было. Вот пара советов, как не скатиться в хаос:

**Документируй.** Создай доку, где прописаны главные понятия, например, гайд по стилю. Положи это туда, где разрабы реально это увидят (например, на самое видное место в Wiki, а не в папку `docs/old/unused/2005`). Заставляй новичков это читать, а стариков — перечитывать, чтобы не расслаблялись. В интернете полно готовых гайдов от гуглов и фейсбуков — начни с них, если лень писать своё.

Для локальных правил (типа инвариантов) пиши комменты прямо в коде. Если ты не запишешь правило, никто, блядь, не будет его соблюдать.

**Принуждай.** Даже с отличной документацией разрабы будут забывать правила. Лучший способ заставить их соблюдать конвенции — написать тулзу, которая бьет их по рукам. Автоматические чекеры (линтеры) не должны давать закоммитить код, если он нарушает правила. Для синтаксиса это работает идеально.

*История из жизни:* На одном проекте у нас была война форматов концов строк. Одни сидели на Unix (`\n`), другие на Windows (`\r\n`). Стоило виндузятнику поправить один символ, его редактор переписывал ВСЕ переносы строк в файле. Гит сходил с ума, дифф показывал, что изменился весь файл. Мы договорились юзать только `\n`, но хрен ты проследишь за каждым редактором каждого джуна. Каждый новый сотрудник начинал с того, что ломал нам репозиторий.

В итоге мы написали скрипт, который запускался перед коммитом. Нашел `\r`? Иди нахер, коммит отменяется. Скрипт мог и сам починить файл. Проблема исчезла мгновенно, а новички быстро дрессировались.

**Код-ревью.** Еще один шанс ткнуть носом в нарушения и обучить молодежь. Чем больше душнил будет на код-ревью, тем быстрее команда выучит правила и тем чище будет код.

**В чужой монастырь...** Самое главное правило: «Делай как местные». Зашел в новый файл? Оглядись, сука. Как тут пишут? Сначала публичные методы, потом приватные? Методы по алфавиту? Переменные в `camelCase` или `snake_case`? Видишь конвенцию — следуй ей. Не надо тащить свои привычки. Если принимаешь проектное решение, посмотри, как решали похожие задачи до тебя. Найди пример и сделай Ctrl+C, Ctrl+V (ну, идейно).

**Не меняй существующие правила.** Сопротивляйся желанию «улучшить» конвенции. Твоя «гениальная идея» — недостаточное оправдание для создания бардака. Единообразие почти всегда важнее, чем то, что один подход чуть лучше другого. Прежде чем внести разлад, спроси себя:
1. Есть ли у меня реально веские причины, которых не было у тех, кто придумал старое правило?
2. Настолько ли новый подход круче, что стоит потратить время на переписывание ВСЕГО старого кода?

Если на оба вопроса ответ «да» (и команда согласна) — вперед, рефактори всё до основания. Чтобы от старого стиля и духу не осталось. Но чаще всего пересмотр правил — это просто просирание времени разработчиков.

## **17.3 Когда ты превращаешься в фашиста стайлгайдов (Taking it too far)**

Единообразие — это не только «делать похожее похожим», но и «делать разное разным». Если ты упорешься по консистентности и начнешь натягивать сову на глобус, пытаясь подогнать разные вещи под один шаблон (например, использовать одно имя переменной для принципиально разных сущностей или пихать паттерн туда, где он нахер не нужен), ты создашь сложность и путаницу.

Единообразие полезно только тогда, когда разраб может быть уверен: «Если это выглядит как утка, то это, сука, утка, а не замаскированная противотанковая мина».

## **17.4 Итог**

Единообразие — это еще один пример инвестиционного мышления. Придется потрахаться сейчас: договориться о правилах, настроить линтеры, искать примеры для подражания и душнить на ревью. Но дивиденды с этой инвестиции — код, который очевиден. Разрабы будут понимать его быстрее, меньше тупить и реже ронять прод.